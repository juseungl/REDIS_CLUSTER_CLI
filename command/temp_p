from redis.cluster import RedisCluster
import sys

def parse_host_port(addr):
    try:
        host, port = addr.split(":")
        return host, int(port)
    except Exception:
        print(f"ì˜ëª»ëœ ip:port í˜•ì‹ì…ë‹ˆë‹¤: {addr}")
        sys.exit(1)

def populate_test_data(node_addr, password, num_keys=100000):
    if num_keys < 1 or num_keys > 10_000_000:
        print("âŒ --num-of-keys ê°’ì€ 1 ì´ìƒ 10,000,000 ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
        sys.exit(1)

    host, port = parse_host_port(node_addr)
    print(f"ğŸ” {node_addr} í´ëŸ¬ìŠ¤í„°ì— ì—°ê²° ì¤‘...")

    try:
        r = RedisCluster(
            host=host,
            port=port,
            password=password,
            decode_responses=True,
            skip_full_coverage_check=True,
        )
        r.ping()
    except Exception as e:
        print(f"âŒ í´ëŸ¬ìŠ¤í„° ì—°ê²° ì‹¤íŒ¨: {e}")
        sys.exit(1)

    print(f"â³ ì´ {num_keys:,} ê°œì˜ ë”ë¯¸ string í‚¤-ê°’ì„ ìƒì„±í•©ë‹ˆë‹¤...")

    batch_size = 1000
    pipe = r.pipeline()

    for i in range(1, num_keys + 1):
        key = f"key:{i:010d}"
        val = f"val:{i:010d}"
        pipe.set(key, val)

        if i % batch_size == 0:
            try:
                pipe.execute()
                print(f" - {i:,} ê°œ ì €ì¥ ì™„ë£Œ")
            except Exception as e:
                print(f"âš ï¸ ì—ëŸ¬ ë°œìƒ (batch {i - batch_size + 1}~{i}): {e}")
                pipe.reset()

    if num_keys % batch_size != 0:
        pipe.execute()

    print(f"ğŸ‰ ë”ë¯¸ ë°ì´í„° ìƒì„± ì™„ë£Œ! ì´ {num_keys:,} ê°œ í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
